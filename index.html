<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZeroKnocks</title>
  <meta name="description" content="A calm, precise unit conversion tool. Twelve converters, zero friction.">
  <meta property="og:title" content="ZeroKnocks">
  <meta property="og:description" content="A calm, precise unit conversion tool.">
  <meta property="og:type" content="website">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%2309090b%22 width=%22100%22 height=%22100%22 rx=%2218%22/><text x=%2250%22 y=%2272%22 text-anchor=%22middle%22 fill=%22%23b8975f%22 font-size=%2258%22 font-family=%22monospace%22 font-weight=%22bold%22>0</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&display=swap" rel="stylesheet"></noscript>
  <meta property="og:image" content="/og-image.png">
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebApplication","name":"ZeroKnocks","description":"A calm, precise unit conversion tool. Twelve converters, zero friction.","applicationCategory":"Utilities"}</script>

  <script>(function(){var t=localStorage.getItem('theme');document.documentElement.setAttribute('data-theme',t||'dark')})()</script>

  <style>
    /*
     * DESIGN SYSTEM
     * Near-black canvas, warm bronze accent. JetBrains Mono for values
     * (weight 500 for legibility on dark bg), DM Sans for labels.
     * Side-by-side converter layout: LEFT ⇄ RIGHT reads naturally.
     * Hairline grid dividers via 1px gap on colored background.
     */

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg:            #08080a;
      --surface:       #101013;
      --surface-hover: #151518;
      --border:        #1e1e24;
      --text-1:        #ececef;
      --text-2:        #88888f;
      --text-3:        #505058;
      --accent:        #b8975f;
      --mono:          'JetBrains Mono', 'Menlo', monospace;
      --sans:          'DM Sans', system-ui, sans-serif;
      color-scheme: dark;
    }

    [data-theme="light"] {
      --bg:            #f4f4f6;
      --surface:       #ffffff;
      --surface-hover: #f0f0f2;
      --border:        #dcdce0;
      --text-1:        #1a1a1f;
      --text-2:        #6b6b73;
      --text-3:        #a0a0a8;
      --accent:        #96723a;
      color-scheme: light;
    }

    [data-theme="light"] .unit-dropdown {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text-1);
      font-family: var(--sans);
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Brand ── */

    .header {
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
    }

    .theme-toggle {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-2);
      font-size: 0.9rem;
      width: 2rem;
      height: 2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s, border-color 0.2s;
    }

    .theme-toggle:hover {
      color: var(--accent);
      border-color: var(--accent);
    }

    .brand {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      font-family: var(--mono);
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      color: var(--text-1);
    }

    /* Anchor both words to center so they never overlap the 0 */
    .brand-left {
      position: absolute;
      right: 50%;
      margin-right: 1rem;
      color: var(--text-2);
      letter-spacing: 0.2em;
    }

    .brand-mark {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.25rem;
      height: 1.25rem;
      border: 1px solid var(--accent);
      border-radius: 50%;
      font-size: 0.6rem;
      font-weight: 500;
      color: var(--accent);
      letter-spacing: 0;
    }

    .brand-right {
      position: absolute;
      left: 50%;
      margin-left: 1rem;
      letter-spacing: 0.32em;
      color: var(--text-2);
    }


    /* ── Grid: 4 cols × 3 rows, hairline dividers ── */

    .grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 1px;
      background: var(--border);
      border-top: 1px solid var(--border);
    }

    /* ── Tile ── */

    .tile {
      background: var(--surface);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem 0.6rem;
      position: relative;
      transition: background 0.2s ease;
      opacity: 0;
      animation: tile-in 0.4s ease forwards;
    }

    .tile:hover {
      background: var(--surface-hover);
    }

    .tile:focus-within {
      background: var(--surface-hover);
    }

    @keyframes tile-in {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ── Category label ── */

    .cat {
      position: absolute;
      top: 0.5rem;
      left: 0.6rem;
      font-size: 0.58rem;
      font-weight: 500;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-1);
    }

    /* ── Side-by-side converter pair ── */

    .pair {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 0.35rem;
      width: 100%;
    }

    .side {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 0;
      position: relative;
    }

    .side input {
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-1);
      font-family: var(--mono);
      font-size: 1.5rem;
      font-weight: 500;
      text-align: center;
      width: 100%;
      padding: 0.15rem 0;
      caret-color: var(--accent);
      transition: border-color 0.2s ease;
    }

    .side input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    /* ── Unit button ── */

    .unit-btn {
      background: none;
      border: none;
      border-bottom: 1px dashed var(--text-3);
      font-family: var(--sans);
      font-size: 0.7rem;
      font-weight: 400;
      color: var(--text-2);
      margin-top: 0.25rem;
      padding: 0 2px 2px;
      cursor: pointer;
      user-select: none;
      line-height: 1;
      transition: color 0.15s ease, border-color 0.15s ease;
    }

    .unit-btn:hover,
    .unit-btn:focus-visible {
      color: var(--text-1);
      border-bottom-color: var(--accent);
      outline: none;
    }

    /* ── Unit dropdown ── */

    .unit-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 150px;
      max-height: 240px;
      overflow-y: auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      padding: 4px 0;
      animation: dropdown-in 0.12s ease;
    }

    .unit-dropdown.above {
      top: auto;
      bottom: calc(100% + 4px);
    }

    @keyframes dropdown-in {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .unit-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.75rem;
      color: var(--text-2);
      white-space: nowrap;
      transition: background 0.1s, color 0.1s;
    }

    .unit-option:hover,
    .unit-option:focus {
      background: var(--surface-hover);
      color: var(--text-1);
      outline: none;
    }

    .unit-option[aria-selected="true"] {
      color: var(--accent);
    }

    .unit-option .symbol {
      font-family: var(--mono);
      font-weight: 500;
      font-size: 0.7rem;
      min-width: 36px;
    }

    .unit-option .name {
      font-family: var(--sans);
      color: var(--text-3);
      font-size: 0.65rem;
    }

    .unit-option:hover .name,
    .unit-option:focus .name {
      color: var(--text-2);
    }

    .unit-dropdown::-webkit-scrollbar { width: 4px; }
    .unit-dropdown::-webkit-scrollbar-track { background: transparent; }
    .unit-dropdown::-webkit-scrollbar-thumb { background: var(--text-3); border-radius: 2px; }

    /* ── Static unit label (non-interactive, for Electrical tile) ── */

    .unit-label {
      font-family: var(--sans);
      font-size: 0.7rem;
      font-weight: 400;
      color: var(--text-2);
      margin-top: 0.25rem;
      user-select: none;
    }

    /* ── Trio layout (3 fields, for Electrical tile) ── */

    .pair.trio { gap: 0.2rem; }
    .pair.trio .mid { font-size: 0.65rem; padding-top: 0.15rem; }

    /* ── Midpoint separator (⇄) ── */

    .mid {
      color: var(--text-3);
      font-size: 0.75rem;
      flex-shrink: 0;
      padding-top: 0.3rem;
      user-select: none;
    }

    /* ── Noscript ── */

    noscript p {
      color: var(--text-2);
      text-align: center;
      padding: 3rem;
      font-size: 0.8rem;
    }

    /* ─────────────────────────────────
     * RESPONSIVE BREAKPOINTS
     * ≥1280 → 4×3, no scroll
     * ≥1024 → 4×3 tighter
     * ≥768  → 3 columns
     * ≥480  → 2 columns
     * <480  → 1 column
     * ───────────────────────────────── */

    @media (max-width: 1279px) {
      .side input { font-size: 1.15rem; }
      .tile { padding: 0.75rem 0.4rem; }
      .unit-btn { font-size: 0.6rem; }
      .pair { gap: 0.25rem; }
    }

    @media (max-width: 1023px) {
      body { overflow: auto; }
      .grid {
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: auto;
      }
      .tile {
        padding: 1.5rem 1rem;
        min-height: 150px;
      }
      .side input { font-size: 1.4rem; }
      .unit-btn { font-size: 0.7rem; }
      .pair { gap: 0.5rem; }
      .unit-option { min-height: 44px; padding: 10px 12px; }
    }

    @media (max-width: 767px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
      .tile { padding: 1.75rem 1rem; }
      .side input { font-size: 1.5rem; }
    }

    @media (max-width: 479px) {
      .grid { grid-template-columns: 1fr; }
      .tile { padding: 1.5rem 1.25rem; min-height: 130px; }
      .side input { font-size: 1.6rem; }
      .pair { gap: 0.75rem; }
    }
  </style>
</head>

<body>
  <header class="header">
    <h1 class="brand"><span class="brand-left">Zero</span><span class="brand-mark" aria-hidden="true">0</span><span class="brand-right">Knocks</span></h1>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme"></button>
  </header>

  <main class="grid" id="grid"></main>

  <noscript><p>JavaScript is required to use ZeroKnocks.</p></noscript>

  <script>
    /* ══════════════════════════════════════════════════
     *  CATEGORY & UNIT DEFINITIONS
     *  Base-unit system: source → base → target
     * ══════════════════════════════════════════════════ */

    const categories = [
      {
        id: 'length', label: 'Length',
        defaultLeft: 'm', defaultRight: 'ft', defaultValue: 1,
        units: [
          { symbol: 'm',  name: 'Meters',      toBase: v => v,            fromBase: v => v },
          { symbol: 'km', name: 'Kilometers',   toBase: v => v * 1000,     fromBase: v => v / 1000 },
          { symbol: 'cm', name: 'Centimeters',  toBase: v => v / 100,      fromBase: v => v * 100 },
          { symbol: 'mm', name: 'Millimeters',  toBase: v => v / 1000,     fromBase: v => v * 1000 },
          { symbol: 'ft', name: 'Feet',         toBase: v => v * 0.3048,   fromBase: v => v / 0.3048 },
          { symbol: 'in', name: 'Inches',       toBase: v => v * 0.0254,   fromBase: v => v / 0.0254 },
          { symbol: 'yd', name: 'Yards',        toBase: v => v * 0.9144,   fromBase: v => v / 0.9144 },
          { symbol: 'mi', name: 'Miles',        toBase: v => v * 1609.344, fromBase: v => v / 1609.344 },
        ]
      },
      {
        id: 'weight', label: 'Weight',
        defaultLeft: 'kg', defaultRight: 'lb', defaultValue: 1,
        units: [
          { symbol: 'kg', name: 'Kilograms',  toBase: v => v,              fromBase: v => v },
          { symbol: 'g',  name: 'Grams',      toBase: v => v / 1000,       fromBase: v => v * 1000 },
          { symbol: 'mg', name: 'Milligrams', toBase: v => v / 1e6,        fromBase: v => v * 1e6 },
          { symbol: 'lb', name: 'Pounds',     toBase: v => v * 0.453592,   fromBase: v => v / 0.453592 },
          { symbol: 'oz', name: 'Ounces',     toBase: v => v * 0.0283495,  fromBase: v => v / 0.0283495 },
          { symbol: 'st', name: 'Stone',      toBase: v => v * 6.35029,    fromBase: v => v / 6.35029 },
        ]
      },
      {
        id: 'temp', label: 'Temperature',
        defaultLeft: '\u00B0C', defaultRight: '\u00B0F', defaultValue: 20,
        units: [
          { symbol: '\u00B0C', name: 'Celsius',    toBase: v => v + 273.15,                fromBase: v => v - 273.15 },
          { symbol: '\u00B0F', name: 'Fahrenheit', toBase: v => (v - 32) * 5 / 9 + 273.15, fromBase: v => (v - 273.15) * 9 / 5 + 32 },
          { symbol: 'K',  name: 'Kelvin',          toBase: v => v,                          fromBase: v => v },
        ]
      },
      {
        id: 'volume', label: 'Volume',
        defaultLeft: 'L', defaultRight: 'gal', defaultValue: 1,
        units: [
          { symbol: 'L',     name: 'Liters',        toBase: v => v,              fromBase: v => v },
          { symbol: 'mL',    name: 'Milliliters',    toBase: v => v / 1000,       fromBase: v => v * 1000 },
          { symbol: 'gal',   name: 'Gallons',        toBase: v => v * 3.78541,    fromBase: v => v / 3.78541 },
          { symbol: 'qt',    name: 'Quarts',         toBase: v => v * 0.946353,   fromBase: v => v / 0.946353 },
          { symbol: 'pt',    name: 'Pints',          toBase: v => v * 0.473176,   fromBase: v => v / 0.473176 },
          { symbol: 'fl oz', name: 'Fluid Ounces',   toBase: v => v * 0.0295735,  fromBase: v => v / 0.0295735 },
          { symbol: 'cup',   name: 'Cups',           toBase: v => v * 0.236588,   fromBase: v => v / 0.236588 },
        ]
      },
      {
        id: 'area', label: 'Area',
        defaultLeft: 'm\u00B2', defaultRight: 'ft\u00B2', defaultValue: 1,
        units: [
          { symbol: 'm\u00B2',  name: 'Sq Meters',      toBase: v => v,              fromBase: v => v },
          { symbol: 'km\u00B2', name: 'Sq Kilometers',   toBase: v => v * 1e6,        fromBase: v => v / 1e6 },
          { symbol: 'cm\u00B2', name: 'Sq Centimeters',  toBase: v => v / 1e4,        fromBase: v => v * 1e4 },
          { symbol: 'ft\u00B2', name: 'Sq Feet',         toBase: v => v * 0.092903,   fromBase: v => v / 0.092903 },
          { symbol: 'in\u00B2', name: 'Sq Inches',       toBase: v => v * 0.00064516, fromBase: v => v / 0.00064516 },
          { symbol: 'yd\u00B2', name: 'Sq Yards',        toBase: v => v * 0.836127,   fromBase: v => v / 0.836127 },
          { symbol: 'ac',  name: 'Acres',           toBase: v => v * 4046.86,    fromBase: v => v / 4046.86 },
          { symbol: 'ha',  name: 'Hectares',        toBase: v => v * 10000,      fromBase: v => v / 10000 },
        ]
      },
      {
        id: 'speed', label: 'Speed',
        defaultLeft: 'km/h', defaultRight: 'mph', defaultValue: 100,
        units: [
          { symbol: 'km/h', name: 'km per hour',     toBase: v => v / 3.6,       fromBase: v => v * 3.6 },
          { symbol: 'mph',  name: 'Miles per hour',   toBase: v => v * 0.44704,   fromBase: v => v / 0.44704 },
          { symbol: 'm/s',  name: 'Meters per sec',   toBase: v => v,             fromBase: v => v },
          { symbol: 'kn',   name: 'Knots',            toBase: v => v * 0.514444,  fromBase: v => v / 0.514444 },
        ]
      },
      {
        id: 'energy', label: 'Energy',
        defaultLeft: 'kcal', defaultRight: 'kJ', defaultValue: 100,
        units: [
          { symbol: 'kcal', name: 'Kilocalories', toBase: v => v * 4184,    fromBase: v => v / 4184 },
          { symbol: 'kJ',   name: 'Kilojoules',   toBase: v => v * 1000,    fromBase: v => v / 1000 },
          { symbol: 'J',    name: 'Joules',        toBase: v => v,           fromBase: v => v },
          { symbol: 'Wh',   name: 'Watt-hours',   toBase: v => v * 3600,    fromBase: v => v / 3600 },
          { symbol: 'BTU',  name: 'BTU',           toBase: v => v * 1055.06, fromBase: v => v / 1055.06 },
        ]
      },
      {
        id: 'power', label: 'Power',
        defaultLeft: 'W', defaultRight: 'hp', defaultValue: 100,
        units: [
          { symbol: 'W',     name: 'Watts',          toBase: v => v,            fromBase: v => v },
          { symbol: 'kW',    name: 'Kilowatts',      toBase: v => v * 1000,     fromBase: v => v / 1000 },
          { symbol: 'hp',    name: 'Horsepower',     toBase: v => v * 745.7,    fromBase: v => v / 745.7 },
          { symbol: 'BTU/h', name: 'BTU per hour',   toBase: v => v * 0.293071, fromBase: v => v / 0.293071 },
        ]
      },
      {
        id: 'pressure', label: 'Pressure',
        defaultLeft: 'bar', defaultRight: 'psi', defaultValue: 1,
        units: [
          { symbol: 'bar',  name: 'Bar',          toBase: v => v * 100000,  fromBase: v => v / 100000 },
          { symbol: 'psi',  name: 'PSI',          toBase: v => v * 6894.76, fromBase: v => v / 6894.76 },
          { symbol: 'atm',  name: 'Atmospheres',  toBase: v => v * 101325,  fromBase: v => v / 101325 },
          { symbol: 'Pa',   name: 'Pascals',      toBase: v => v,           fromBase: v => v },
          { symbol: 'kPa',  name: 'Kilopascals',  toBase: v => v * 1000,    fromBase: v => v / 1000 },
          { symbol: 'mmHg', name: 'mmHg',         toBase: v => v * 133.322, fromBase: v => v / 133.322 },
        ]
      },
      {
        id: 'data', label: 'Data',
        defaultLeft: 'GB', defaultRight: 'MB', defaultValue: 1,
        units: [
          { symbol: 'B',  name: 'Bytes',     toBase: v => v,                  fromBase: v => v },
          { symbol: 'KB', name: 'Kilobytes', toBase: v => v * 1024,           fromBase: v => v / 1024 },
          { symbol: 'MB', name: 'Megabytes', toBase: v => v * 1048576,        fromBase: v => v / 1048576 },
          { symbol: 'GB', name: 'Gigabytes', toBase: v => v * 1073741824,     fromBase: v => v / 1073741824 },
          { symbol: 'TB', name: 'Terabytes', toBase: v => v * 1099511627776,  fromBase: v => v / 1099511627776 },
        ]
      },
      {
        id: 'time', label: 'Time',
        defaultLeft: 'hr', defaultRight: 'min', defaultValue: 1,
        units: [
          { symbol: 's',   name: 'Seconds',  toBase: v => v,            fromBase: v => v },
          { symbol: 'min', name: 'Minutes',  toBase: v => v * 60,       fromBase: v => v / 60 },
          { symbol: 'hr',  name: 'Hours',    toBase: v => v * 3600,     fromBase: v => v / 3600 },
          { symbol: 'day', name: 'Days',     toBase: v => v * 86400,    fromBase: v => v / 86400 },
          { symbol: 'wk',  name: 'Weeks',    toBase: v => v * 604800,   fromBase: v => v / 604800 },
          { symbol: 'mo',  name: 'Months',   toBase: v => v * 2592000,  fromBase: v => v / 2592000 },
          { symbol: 'yr',  name: 'Years',    toBase: v => v * 31557600, fromBase: v => v / 31557600 },
        ]
      },
    ];

    /* ── Runtime state ── */

    const state = {};
    const lastEdited = {};

    /* ── Formatting: precise but clean ── */

    function fmt(n) {
      if (!Number.isFinite(n)) return '';
      if (n === 0) return '0';
      const a = Math.abs(n);
      if (a >= 100000) return parseFloat(n.toPrecision(6)).toString();
      if (a >= 1)      return parseFloat(n.toFixed(4)).toString();
      return parseFloat(n.toPrecision(4)).toString();
    }

    /* ── Build tiles ── */

    const grid = document.getElementById('grid');
    const TILE_ANIMATION_STAGGER_MS = 40;

    categories.forEach((cat, i) => {
      state[cat.id] = { left: cat.defaultLeft, right: cat.defaultRight };
      lastEdited[cat.id] = 'left';

      const leftUnit = cat.units.find(u => u.symbol === cat.defaultLeft);
      const rightUnit = cat.units.find(u => u.symbol === cat.defaultRight);
      const leftVal = cat.defaultValue;
      const rightVal = fmt(rightUnit.fromBase(leftUnit.toBase(leftVal)));

      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.style.animationDelay = `${i * TILE_ANIMATION_STAGGER_MS}ms`;
      tile.setAttribute('role', 'group');
      tile.setAttribute('aria-label', `${cat.label} converter`);
      tile.innerHTML = `
        <span class="cat">${cat.label}</span>
        <div class="pair">
          <div class="side">
            <input type="text" inputmode="decimal"
                   data-id="${cat.id}" data-side="left"
                   value="${leftVal}" aria-label="${leftUnit.name} value">
            <button class="unit-btn" data-id="${cat.id}" data-side="left"
                    aria-haspopup="listbox" aria-expanded="false">${cat.defaultLeft}</button>
          </div>
          <span class="mid">\u21C4</span>
          <div class="side">
            <input type="text" inputmode="decimal"
                   data-id="${cat.id}" data-side="right"
                   value="${rightVal}" aria-label="${rightUnit.name} value">
            <button class="unit-btn" data-id="${cat.id}" data-side="right"
                    aria-haspopup="listbox" aria-expanded="false">${cat.defaultRight}</button>
          </div>
        </div>`;
      grid.appendChild(tile);
    });

    /* Electrical tile (12th) — 3-field calculator: V × A = W */
    (function () {
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.style.animationDelay = `${categories.length * TILE_ANIMATION_STAGGER_MS}ms`;
      tile.setAttribute('role', 'group');
      tile.setAttribute('aria-label', 'Electrical calculator');
      tile.innerHTML = `
        <span class="cat">Electrical</span>
        <div class="pair trio">
          <div class="side">
            <input type="text" inputmode="decimal"
                   data-id="electrical" data-field="v"
                   value="120" aria-label="Volts value">
            <span class="unit-label">V</span>
          </div>
          <span class="mid">\u00D7</span>
          <div class="side">
            <input type="text" inputmode="decimal"
                   data-id="electrical" data-field="a"
                   value="1" aria-label="Amps value">
            <span class="unit-label">A</span>
          </div>
          <span class="mid">=</span>
          <div class="side">
            <input type="text" inputmode="decimal"
                   data-id="electrical" data-field="w"
                   value="120" aria-label="Watts value">
            <span class="unit-label">W</span>
          </div>
        </div>`;
      grid.appendChild(tile);
    })();

    /* ── Electrical calculator state ── */

    const elecEdited = ['v', 'a'];

    function trackElecField(field) {
      const idx = elecEdited.indexOf(field);
      if (idx === 0) {
        [elecEdited[0], elecEdited[1]] = [elecEdited[1], elecEdited[0]];
      } else if (idx === -1) {
        elecEdited[0] = elecEdited[1];
        elecEdited[1] = field;
      }
    }

    function computeElectrical() {
      const vIn = grid.querySelector('input[data-id="electrical"][data-field="v"]');
      const aIn = grid.querySelector('input[data-id="electrical"][data-field="a"]');
      const wIn = grid.querySelector('input[data-id="electrical"][data-field="w"]');
      const v = parseFloat(vIn.value), a = parseFloat(aIn.value), w = parseFloat(wIn.value);
      const toCompute = ['v', 'a', 'w'].find(f => !elecEdited.includes(f));

      if (toCompute === 'w' && !isNaN(v) && !isNaN(a)) {
        wIn.value = fmt(v * a);
      } else if (toCompute === 'v' && !isNaN(w) && !isNaN(a) && a !== 0) {
        vIn.value = fmt(w / a);
      } else if (toCompute === 'a' && !isNaN(w) && !isNaN(v) && v !== 0) {
        aIn.value = fmt(w / v);
      } else {
        wIn.value = '';
      }
    }

    /* ── Conversion engine ── */

    function convert(id, side, value) {
      const cat = categories.find(c => c.id === id);
      const fromUnit = cat.units.find(u => u.symbol === state[id][side]);
      const toSide = side === 'left' ? 'right' : 'left';
      const toUnit = cat.units.find(u => u.symbol === state[id][toSide]);
      const result = toUnit.fromBase(fromUnit.toBase(value));
      grid.querySelector(`input[data-id="${id}"][data-side="${toSide}"]`).value = fmt(result);
    }

    /* ── Dropdown management ── */

    let activeDropdown = null;

    function openDropdown(button) {
      closeDropdown();

      const catId = button.dataset.id;
      const side = button.dataset.side;
      const cat = categories.find(c => c.id === catId);
      const currentSymbol = state[catId][side];

      const dropdown = document.createElement('div');
      dropdown.className = 'unit-dropdown';
      dropdown.setAttribute('role', 'listbox');

      cat.units.forEach(u => {
        const opt = document.createElement('div');
        opt.className = 'unit-option';
        opt.setAttribute('role', 'option');
        opt.setAttribute('tabindex', '-1');
        opt.setAttribute('aria-selected', u.symbol === currentSymbol ? 'true' : 'false');
        opt.dataset.symbol = u.symbol;
        opt.dataset.id = catId;
        opt.dataset.side = side;
        opt.innerHTML = `<span class="symbol">${u.symbol}</span><span class="name">${u.name}</span>`;
        dropdown.appendChild(opt);
      });

      const sideEl = button.closest('.side');
      sideEl.appendChild(dropdown);

      /* Elevate tile so dropdown isn't clipped by adjacent tiles */
      const tile = button.closest('.tile');
      tile.style.zIndex = '10';

      /* Open above if dropdown clips below viewport */
      const rect = dropdown.getBoundingClientRect();
      if (rect.bottom > window.innerHeight) {
        dropdown.classList.add('above');
      }

      button.setAttribute('aria-expanded', 'true');
      activeDropdown = { dropdown, button, tile };

      /* Focus selected option for keyboard users */
      const selected = dropdown.querySelector('[aria-selected="true"]');
      if (selected) selected.focus();
    }

    function closeDropdown() {
      if (!activeDropdown) return;
      activeDropdown.dropdown.remove();
      activeDropdown.button.setAttribute('aria-expanded', 'false');
      activeDropdown.tile.style.zIndex = '';
      activeDropdown = null;
    }

    function selectUnit(catId, side, symbol) {
      state[catId][side] = symbol;

      /* Update button text */
      const btn = grid.querySelector(`.unit-btn[data-id="${catId}"][data-side="${side}"]`);
      btn.textContent = symbol;

      /* Update aria-label on corresponding input */
      const cat = categories.find(c => c.id === catId);
      const unit = cat.units.find(u => u.symbol === symbol);
      const input = grid.querySelector(`input[data-id="${catId}"][data-side="${side}"]`);
      input.setAttribute('aria-label', `${unit.name} value`);

      /* Re-convert using last-edited side as source of truth */
      const sourceSide = lastEdited[catId];
      const sourceInput = grid.querySelector(`input[data-id="${catId}"][data-side="${sourceSide}"]`);
      const val = parseFloat(sourceInput.value);
      if (!isNaN(val)) convert(catId, sourceSide, val);

      closeDropdown();
      btn.focus();
    }

    /* ── Event delegation ── */

    /* Real-time conversion on every keystroke */
    grid.addEventListener('input', (e) => {
      if (e.target.tagName !== 'INPUT') return;
      const { id, side, field } = e.target.dataset;

      /* Electrical calculator */
      if (id === 'electrical') {
        trackElecField(field);
        const raw = e.target.value.trim();
        if (raw === '' || raw === '-' || raw === '.') {
          const toCompute = ['v', 'a', 'w'].find(f => !elecEdited.includes(f));
          grid.querySelector(`input[data-id="electrical"][data-field="${toCompute}"]`).value = '';
          return;
        }
        computeElectrical();
        return;
      }

      /* Standard converter */
      lastEdited[id] = side;
      const raw = e.target.value.trim();
      if (raw === '' || raw === '-' || raw === '.') {
        grid.querySelector(
          `input[data-id="${id}"][data-side="${side === 'left' ? 'right' : 'left'}"]`
        ).value = '';
        return;
      }
      const val = parseFloat(raw);
      if (!isNaN(val)) convert(id, side, val);
    });

    /* Select all on focus for quick re-entry */
    grid.addEventListener('focusin', (e) => {
      if (e.target.tagName === 'INPUT') e.target.select();
    });

    /* Click: toggle dropdown or select option */
    grid.addEventListener('click', (e) => {
      const opt = e.target.closest('.unit-option');
      if (opt) {
        selectUnit(opt.dataset.id, opt.dataset.side, opt.dataset.symbol);
        return;
      }

      const btn = e.target.closest('.unit-btn');
      if (btn) {
        if (activeDropdown && activeDropdown.button === btn) {
          closeDropdown();
        } else {
          openDropdown(btn);
        }
      }
    });

    /* Close dropdown on outside click */
    document.addEventListener('click', (e) => {
      if (activeDropdown && !e.target.closest('.unit-dropdown') && !e.target.closest('.unit-btn')) {
        closeDropdown();
      }
    });

    /* Keyboard: open/close/navigate dropdowns */
    grid.addEventListener('keydown', (e) => {
      /* Open/close from unit button */
      if (e.target.classList.contains('unit-btn') && (e.key === 'Enter' || e.key === ' ')) {
        e.preventDefault();
        if (activeDropdown && activeDropdown.button === e.target) {
          closeDropdown();
        } else {
          openDropdown(e.target);
        }
        return;
      }

      if (!activeDropdown) return;

      /* Escape: close and return focus to button */
      if (e.key === 'Escape') {
        e.preventDefault();
        const btn = activeDropdown.button;
        closeDropdown();
        btn.focus();
        return;
      }

      /* Tab: close and let focus proceed naturally */
      if (e.key === 'Tab') {
        closeDropdown();
        return;
      }

      /* Arrow navigation within dropdown */
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        const options = [...activeDropdown.dropdown.querySelectorAll('.unit-option')];
        let idx = options.indexOf(document.activeElement);
        if (e.key === 'ArrowDown') idx = idx < options.length - 1 ? idx + 1 : 0;
        else idx = idx > 0 ? idx - 1 : options.length - 1;
        options.forEach((opt, i) => opt.setAttribute('aria-selected', i === idx ? 'true' : 'false'));
        options[idx].focus();
        return;
      }

      /* Enter/Space: select focused option */
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (document.activeElement.classList.contains('unit-option')) {
          const f = document.activeElement;
          selectUnit(f.dataset.id, f.dataset.side, f.dataset.symbol);
        }
      }
    });
    /* ── Theme toggle ── */
    (function () {
      const btn = document.getElementById('theme-toggle');
      const root = document.documentElement;
      function update() {
        const isLight = root.getAttribute('data-theme') === 'light';
        btn.textContent = isLight ? '\u263E' : '\u2600';
        btn.setAttribute('aria-label', isLight ? 'Switch to dark mode' : 'Switch to light mode');
      }
      btn.addEventListener('click', () => {
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        update();
      });
      update();
    })();
  </script>
</body>
</html>
